---
title: "STA 325 Case Study"
author: "Ella Tillinghast"
output: html_document
---
This is what I came up with for our first steps!

### Load Data + Libraries
```{r}

library(tidyverse)
library(tidymodels)
library(dplyr)
library(broom)
library(car)
library(ggplot2)
library(MuMIn)
library(splines)
library(GGally)
library(readr)
library(reshape2)
library(corrplot)

train <- read_csv("Data/data-train.csv")
test <- read_csv("Data/data-test.csv")


```


### Understanding the data
```{r}

str(train)

summary(train)

colSums(is.na(train))


```


### Distribution of Moments
```{r}
moment_cols <- c("R_moment_1", "R_moment_2", "R_moment_3", "R_moment_4")

for (col in moment_cols) {
  print(
    ggplot(train, aes_string(x = col)) +
      geom_histogram(bins = 30, fill = "#69b3a2", color = "white") +
      theme_minimal() +
      labs(title = paste("Distribution of", col))
  )
}
```

### Transformations

```{r}
ggplot(train, aes(x = log1p(R_moment_1))) + geom_histogram(fill = "#69b3a2") +
  labs(title = "R_moment_1_logged")

ggplot(train, aes(x = log1p(R_moment_2))) + geom_histogram(fill = "#69b3a2") +
  labs(title = "R_moment_2_logged")

ggplot(train, aes(x = log1p(R_moment_3))) + geom_histogram(fill = "#69b3a2") +
  labs(title = "R_moment_3_logged")

ggplot(train, aes(x = log1p(R_moment_4))) + geom_histogram(fill = "#69b3a2") +
  labs(title = "R_moment_4_logged")

```
Applying a log helps to stablize data across all moments (clearer/easier to read)


### Correlation
```{r}

num_vars_Re <- train[, c("Re", moment_cols)]
cor_mat <- cor(num_vars_Re, use = "complete.obs")

corrplot(cor_mat, method = "color", type = "upper", tl.cex = 0.8)


num_vars_St <- train[, c("St", moment_cols)]
cor_mat <- cor(num_vars_St, use = "complete.obs")

corrplot(cor_mat, method = "color", type = "upper", tl.cex = 0.8)

num_vars_Fr <- train[, c("Fr", moment_cols)]
cor_mat <- cor(num_vars_Fr, use = "complete.obs")

corrplot(cor_mat, method = "color", type = "upper", tl.cex = 0.8)
```

### Group-Level Patterns (I think I should log the vars)
```{r}

train %>%
group_by(St) %>%
summarise(across(all_of(moment_cols),
list(mean = mean, sd = sd),
na.rm = TRUE)) %>%
pivot_longer(-St, names_to = c("Moment", ".value"),
names_pattern = "(.*)_(mean|sd)") %>%
ggplot(aes(x = St, y = mean, fill = Moment)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd),
position = position_dodge(0.9), width = 0.2) +
theme_minimal() +
labs(title = "Average Moments by St (with SD error bars)",
x = "St", y = "Mean Moment")


```
```{r}

## Fix
m_logr1 <- lm(log1p(R_moment_1) ~ Re + St + Fr, data = train)


summary(m_logr1)

par(mfrow = c(2, 2))
plot(m_logr1)
par(mfrow = c(1, 1))


test <- test %>%
  mutate(R1_log = log1p(R_moment_1)) %>%
  drop_na(Re, St, Fr, R1_log)

pred_m_logr1 <- predict(m_logr1, newdata = test)

rmse_logr1 <- sqrt(mean((pred_m_logr1 - test$R1_log)^2))
r2_logr1 <- cor(pred_m_logr1, test$R1_log)^2

cat("m_logr1 — Test RMSE:", rmse_logr1, "\n")
cat("m_logr1 — Test R²:", r2_logr1, "\n")

ggplot(test, aes(x = R1_log, y = pred_m_logr1)) +
  geom_point(alpha = 0.4) +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  theme_minimal() +
  labs(
    title = "m_logr1: Predicted vs Actual (Test Set)",
    x = "Actual log1p(R_moment_1)",
    y = "Predicted"
  )


```

